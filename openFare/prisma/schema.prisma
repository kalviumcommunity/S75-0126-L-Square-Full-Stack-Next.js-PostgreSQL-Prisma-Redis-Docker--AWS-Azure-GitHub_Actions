generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             Int             @id @default(autoincrement())
  name           String
  email          String          @unique
  createdAt      DateTime        @default(now())
  phone          String?
  password       String          // Required for authentication
  role           UserRole        @default(PASSENGER)
  refreshTokenId String?         // For refresh token rotation
  bookings       Booking[]
  refundRequests RefundRequest[]

  @@index([createdAt])
  @@index([role])
  @@index([email])
}

model BusOperator {
  id                 Int      @id @default(autoincrement())
  name               String
  licenseNumber      String   @unique
  contactEmail       String
  contactPhone       String
  cancellationPolicy String
  createdAt          DateTime @default(now())
  routes             Route[]

  @@index([createdAt])
}

model Route {
  id          Int         @id @default(autoincrement())
  origin      String
  destination String
  distance    Float
  operatorId  Int
  operator    BusOperator @relation(fields: [operatorId], references: [id])
  schedules   Schedule[]

  @@index([operatorId])
  @@index([origin, destination])
}

model Schedule {
  id             Int       @id @default(autoincrement())
  routeId        Int
  departureTime  DateTime
  arrivalTime    DateTime
  price          Float
  availableSeats Int
  createdAt      DateTime  @default(now())
  bookings       Booking[]
  route          Route     @relation(fields: [routeId], references: [id])

  @@index([departureTime])
  @@index([routeId])
}

model Booking {
  id            Int            @id @default(autoincrement())
  bookingNumber String         @unique
  userId        Int
  scheduleId    Int
  seatNumber    String
  totalPrice    Float
  status        BookingStatus  @default(CONFIRMED)
  bookedAt      DateTime       @default(now())
  cancelledAt   DateTime?
  schedule      Schedule       @relation(fields: [scheduleId], references: [id])
  user          User           @relation(fields: [userId], references: [id])
  refundRequest RefundRequest?

  @@index([bookedAt])
  @@index([scheduleId])
  @@index([status])
  @@index([userId])
}

model RefundRequest {
  id              Int              @id @default(autoincrement())
  bookingId       Int              @unique
  userId          Int
  requestedAmount Float
  approvedAmount  Float?
  reason          String
  status          RefundStatus     @default(PENDING)
  requestedAt     DateTime         @default(now())
  processedAt     DateTime?
  processorNotes  String?
  booking         Booking          @relation(fields: [bookingId], references: [id])
  user            User             @relation(fields: [userId], references: [id])
  timeline        RefundTimeline[]

  @@index([status])
  @@index([userId])
}

model RefundTimeline {
  id              Int           @id @default(autoincrement())
  refundRequestId Int
  status          String
  notes           String?
  createdAt       DateTime      @default(now())
  refundRequest   RefundRequest @relation(fields: [refundRequestId], references: [id])

  @@index([createdAt])
  @@index([refundRequestId])
}

enum UserRole {
  PASSENGER
  OPERATOR
  ADMIN
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
}